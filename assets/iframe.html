<html>
<body>
  <link rel="stylesheet" href="app.css"> <!--CSS-->
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script> <!--ZAF-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script> <!--JQuery-->
  <script type="text/javascript" src="/libraries/underscore-min.js"></script> <!--Underscore.JS-->
  <script type="text/javascript" src="/libraries/jquery-min.js"></script>
  <script type="text/javascript" src="/libraries/jquery-ui-min.js"></script>
  <script type="text/javascript" src="/libraries/selectBoxIt-min.js"></script>
  <div>
  <p><span class="label">Ticket Requester:</span></p>
  <p class="data_requester"><span  id="requester">{{ticket.requester}}</span></p>
  <p><span class="label">Select a New Requester from CCs:</span></p>
  <p class="data_collaborators"><select id="collaborators"><option></option></select></p>
  <p><span class="label">Keep old Requester as CC:</span>
  <label id="checkbox_label">
  <input type='checkbox' id="cc_checkbox">
  <span class="data"></span>
  </label>
  <div><input type="submit" value="Submit" class="button" id="submit_change"></div>
  <script>
    var ticketRequester = $('#requester');
    var ticketCollaborators = $('#collaborators');
    var submitButton = $('#submit_change');
    var client = ZAFClient.init();
    client.invoke('resize', { width: '100%', height: '225px' });
    client.get('ticket').then(function(data) {
    	var ticketID = data.ticket.id;
    	var requesterName = data.ticket.requester.name;
    	var requesterID = data.ticket.requester.id;
    	var collaborators = data.ticket.collaborators;
    	var collaboratorsSorted = _.sortBy(collaborators, 'name');
    	$.each(collaboratorsSorted, function(index, value) {
    		var collaboratorName = value.name;
    		var collaboratorID = value.id;
    		$(ticketCollaborators).append($('<option>', {value:collaboratorID, text:collaboratorName}));
    	}); 
    	var collaboratorsArray = new Array();
    	$('#collaborators option').each(function() {
    		if ($(this).val() != "") {
    			var collaboratorsIDs = Number($(this).val());
    			collaboratorsArray.push(collaboratorsIDs);
    		}
    	});
    	$("select").selectBoxIt({
    		showFirstOption: false
    	});
    	ticketRequester.text(requesterName);
    	submitButton.click(function() {
    		var selectedCC = $('#collaborators option:selected').val();
    		if (selectedCC > 0) {
	    		var selectedCCValue = Number(selectedCC);
	    		var changeRequester = {
	    			url: '/api/v2/tickets/' + ticketID + '.json',
	    			type: 'PUT',
	    			contentType: "application/json",
	    			data: '{"ticket": {"requester_id": ' + selectedCCValue + '}}'
	    		};
	    		var collaboratorsArrayRequester = new Array(); 
	    		collaboratorsArrayRequester.push(requesterID);
	    		var collaboratorsArrayRequesterUnion = _.union(collaboratorsArrayRequester, collaboratorsArray);
	    		var collaboratorsArrayAdd = _.without(collaboratorsArrayRequesterUnion, selectedCCValue);
	    		var addCC = {
	    			url: '/api/v2/tickets/' + ticketID + '.json',
	    			type: 'PUT',
	    			contentType: "application/json",
	    			data: '{"ticket": {"collaborator_ids": [' + collaboratorsArrayAdd + ']}}' //test
	    		};
	    		var collaboratorsArrayRemove = _.without(collaboratorsArray, selectedCCValue);
	    		var removeCC = {
	    			url: '/api/v2/tickets/' + ticketID + '.json',
	    			type: 'PUT',
	    			contentType: "application/json",
	    			data: '{"ticket": {"collaborator_ids": [' + collaboratorsArrayRemove + ']}}' //test
	    		};
	    		var ccCurrentRequester = $('#cc_checkbox').is(':checked');
	    		if (ccCurrentRequester == true) {
	    			client.request(addCC).then(function() {
	    				client.request(changeRequester);
	    			});
	    		} 
	    		if (ccCurrentRequester != true) {
	    			client.request(changeRequester).then(function() {
	    				client.request(removeCC);
	    			});
	    		}
	    	}
    	});
	});
	client.on('ticket.updated', function() {
		window.location.reload();
	});
  </script>
</body>
</html>
